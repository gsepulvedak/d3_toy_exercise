<!DOCTYPE html>
<html>
    <head>
        
        <title>Pedestrian hourly average count</title>
        <link rel="stylesheet" href="ped_count.css">
        
    </head>
    
    <body>
        
        <h1>FIT5147 - D3 programming exercise</h1>
        <h2>Semester 2 - 2020</h2>
        
<!--    tooltip-->
        <div id="tooltip" class="hidden">
            <p>Day type: <span id="dayType">0</span></p>
            <p>Day hour: <span id="dayTime">0</span></p>
            <p>Pedestrian average count: <span id="average">0</span></p>        
        </div>
        
        <svg></svg>
        
        <script src="https://d3js.org/d3.v4.min.js"></script>
        
        <script>
            
            // set svg configuration
            var height = 600;
            var width = 960;
            var svg = d3.selectAll("svg")
                .attr("height", height)
                .attr("width", width)
                .attr("class", "canvas");
            
            // data type casting function for csv reading
            var rowParser = function(d) {
                return {
                    Day: d.Day,
                    TimeOfDay: parseInt(d.TimeOfDay),
                    HourlyAverage: parseFloat(d.HourlyAverage)                    
                }
            };
            
            // group filtering function
            var filterData = function(d, group){
                return d.filter(function(v){return v.Day == group})
            };
            
            // read data and create visualisation
            d3.csv("data/PedestrianCountingSystemWeekdaysAndWeekends.csv", rowParser, function(d){
                console.log(d); //REMOVE THIS LATER ##############################################################################
                
                // set graph margin
                var margin = {left: 50, 
                              top: 40, 
                              right: 40, 
                              bottom: 50};
                
                // x-axis scale
                var xScale = d3.scaleLinear()
                                .domain(d3.extent(d, function(v) {return v["TimeOfDay"]}))
                                .range([margin.left, width - margin.right]);
                
                
                //y-axis scale
                var yScale = d3.scaleLinear()
                                .domain([0, 
                                         d3.max(d, function(v){return v["HourlyAverage"]}
                                )])
                                .range([height - margin.bottom, margin.top]);
                
                // x-axis
                var xAxis = d3.axisBottom()
                                .scale(xScale)
                                .ticks(24); // a bit of customisation
                
                // y-axis
                var yAxis = d3.axisLeft()
                                .scale(yScale)
                                .ticks(14); // a bit of customisation
                                
                // create line generator
                var dataSeries = d3.line()
                                    .x(function(d){return xScale(d.TimeOfDay)})
                                    .y(function(d){return yScale(d.HourlyAverage)})
                
                // draw line paths
                // weekends
                svg.append("path")
                    .datum(filterData(d, "Weekend"))
                    .attr("class", "line weekend")
                    .attr("d", dataSeries);
                
                // weekdays
                svg.append("path")
                    .datum(filterData(d, "Weekday"))
                    .attr("class", "line weekday")
                    .attr("d", dataSeries);
                
                // draw circles
                svg.selectAll("circle")
                    .data(d)
                    .enter()
                    .append("circle")
                    .attr("cx", function(d){
                        return xScale(d.TimeOfDay)
                })
                    .attr("cy", function(d){
                        return yScale(d.HourlyAverage)
                })
                    .attr("r", 5)
                    .attr("class", function(v){
                        if (v.Day == "Weekday"){
                            return "datapoint weekday"
                        } else {
                            return "datapoint weekend"
                        };
                })
                // show tooltip
                    .on("mouseover", function(d){
                    
                    var xPosition = parseFloat(d3.select(this).attr("cx"));                 
                    var yPosition = parseFloat(d3.select(this).attr("cy"));
                    
                    console.log(d.HourlyAverage);
                    
                    d3.select("#tooltip")
                        .style("left", (xPosition + 20) + "px")
                        .style("top", (yPosition + 30) + "px")
                        .select("#dayType")
                        .text(d.Day);
                    
                    d3.select("#dayTime")
                        .text(d.TimeOfDay);
                    
                    d3.select("#average")
                        .text(Math.round(d.HourlyAverage *100)/100);
                    
                    d3.select("#tooltip")
                        .classed("hidden", false);
                        
                })
                    .on("mouseout", function(){
                        d3.select("#tooltip").classed("hidden", true);
                });
                
                // draw axes
                svg.append("g")
                    .attr("transform", "translate(0," + (height - margin.bottom) + ")")
                    .call(xAxis);
                
                svg.append("g")
                    .attr("transform", "translate(" + margin.left + ", 0)")
                    .call(yAxis);
                
                // annotation text
                var annotation = "Pedestrian counts during weekdays fluctuate at peak hours, whereas counts during weekends grow and shrink steadily throughout the day. Weekday peaks correspond to work starting hours, lunch time and work ending hours, at hours 8, 12-13 and 17. On weekends, this pattern is replaced by a soft pedestrian increase and decrease troughout the day."
                
                // annotation
                svg.append("foreignObject")
                    .attr("width", 400)
                    .attr("height", 110)
                    .attr("x", width / 10)
                    .attr("y", margin.top)
                    .append("xhtml:body")
                        .attr("class", "annotation")
                        .html(annotation);
            
            
        });
        
            
            
        </script>
    </body>
</html>